## Row Hammering notes
This document contains notes about DRAM Row Hammering.


### DRAM background
This issue in this case is with DRAM and how memory cells are packed closer and
closer together which and are so close that electrons can interact with
neighboring cells.

Now, a DRAM memory cell usually consists of a tiny capacitor and a transistor
where the capacitor is either charged or discharged and these two different
states represent the two values of a bit 0 or 1. Now, a capacitor will
discharge a little so it needs to be charged or the state will be lost and this
is accomplished by refreshing/charging/re-reading the capacitor a certain number
, actually the whole row, of times per second. This is where Dynamic comes from
in DRAM.

A cell can look something like this:
```
          | Gate
          |
       ------                Transistor
       +----+
 Source|    | Drain
 ------+    +------+
                   |
                   |
                 -----       Capacitor
                 -----
                   |
                   |
                   |
                 -----
                  --          Ground
                   -
```
When the gate is open, current can flow through the transistor from the source
to the drain and the capacitor will charge. It only takes a few nano seconds
for the capcitor to charge.

Whe the date is closed, the source current is blocket, and the capacitor remains
charged.

```
B = bit line
W = word line

              B0     B1     B2     B3     B4     B5     B6     B7
               |      |      |      |      |      |      |      |
W0             |      |      |      |      |      |      |      |
---------------|--*---|--*---|--*---|--*---|--*---|--*---|--*---|--*--
               |  |   |  |   |  |   |  |   |  |   |  |   |  |   |  |
W1             *--C   *--C   *--C   *--C   *--C   *--C   *--C   *--C
---------------|------|------|------|------|------|------|------|--*--
               |  | 1 |  | 0 |  | 1 |  | 0 |  | 0 |  | 1 |  | 1 |  | 0
W2             *--C   *--C   *--C   *--C   *--C   *--C   *--C   *--C
---------------|------|------|------|------|------|------|------|--*--
               |  |   |  |   |  |   |  |   |  |   |  |   |  |   |  |
W3             *--C   *--C   *--C   *--C   *--C   *--C   *--C   *--C
---------------|------|------|------|------|------|------|------|--*--
               |  |   |  |   |  |   |  |   |  |   |  |   |  |   |  |
W4             *--C   *--C   *--C   *--C   *--C   *--C   *--C   *--C
---------------|------|------|------|------|------|------|------|--*--
               |  |   |  |   |  |   |  |   |  |   |  |   |  |   |  |
W5             *--C   *--C   *--C   *--C   *--C   *--C   *--C   *--C
---------------|------|------|------|------|------|------|------|--*--
               |  |   |  |   |  |   |  |   |  |   |  |   |  |   |  |
W6             *--C   *--C   *--C   *--C   *--C   *--C   *--C   *--C
---------------|------|------|------|------|------|------|------|--*--
               |  |   |  |   |  |   |  |   |  |   |  |   |  |   |  |
W7             *--C   *--C   *--C   *--C   *--C   *--C   *--C   |--C
---------------|------|------|------|------|------|------|------|-----
               |      |      |      |      |      |      |      |
               |      |      |      |      |      |      |      |
Sence       +----+ +----+ +----+ +----+ +----+ +----+ +----+ +----+
Amplifier   | S0 | | S1 | | S2 | | S3 | | S4 | | S5 | | S6 | | S7 |
            |    | |    | |    | |    | |    | |    | |    | |    |
            +----+ +----+ +----+ +----+ +----+ +----+ +----+ +----+
              |      |      |      |      |      |      |      |

```
What happens then is that the bit lines, yes all the bit lines, are precharged
,in this example with 1.5V, and those cells are disconnected from ground. This
this state is called floating:
```
              B0     B1     B2     B3     B4     B5     B6     B7
               |      |      |      |      |      |      |      |
W0             |      |      |      |      |      |      |      |
---------------|--*---|--*---|--*---|--*---|--*---|--*---|--*---|--*--
               |  |   |  |   |  |   |  |   |  |   |  |   |  |   |  |
W1             *--C   *--C   *--C   *--C   *--C   *--C   *--C   *--C
---------------|------|------|------|------|------|------|------|--*--
               |  | 1 |  | 0 |  | 1 |  | 0 |  | 0 |  | 1 |  | 1 |  | 0
W2             *--C   *--C   *--C   *--C   *--C   *--C   *--C   *--C
---------------|------|------|------|------|------|------|------|--*--
               |  |   |  |   |  |   |  |   |  |   |  |   |  |   |  |
W3             *--C   *--C   *--C   *--C   *--C   *--C   *--C   *--C
---------------|------|------|------|------|------|------|------|--*--
               |  |   |  |   |  |   |  |   |  |   |  |   |  |   |  |
W4             *--C   *--C   *--C   *--C   *--C   *--C   *--C   *--C
---------------|------|------|------|------|------|------|------|--*--
               |  |   |  |   |  |   |  |   |  |   |  |   |  |   |  |
W5             *--C   *--C   *--C   *--C   *--C   *--C   *--C   *--C
---------------|------|------|------|------|------|------|------|--*--
               |  |   |  |   |  |   |  |   |  |   |  |   |  |   |  |
W6             *--C   *--C   *--C   *--C   *--C   *--C   *--C   *--C
---------------|------|------|------|------|------|------|------|--*--
               |  |   |  |   |  |   |  |   |  |   |  |   |  |   |  |
W7             *--C   *--C   *--C   *--C   *--C   *--C   *--C   |--C
---------------|------|------|------|------|------|------|------|-----
               |      |      |      |      |      |      |      |
          1.5V | 1.5V | 1.5V | 1.5V | 1.5V | 1.5V | 1.5V | 1.5V |
Sence       +----+ +----+ +----+ +----+ +----+ +----+ +----+ +----+
Amplifier   | S0 | | S1 | | S2 | | S3 | | S4 | | S5 | | S6 | | S7 |
            |    | |    | |    | |    | |    | |    | |    | |    |
            +----+ +----+ +----+ +----+ +----+ +----+ +----+ +----+
         1.5V | 1.5V | 1.5V | 1.5V | 1.5V | 1.5V | 1.5V | 1.5V |
```
After that the wordline is set to a relatively low voltage. This is only done
for the row that contains the bit that we are want to read. Notice that the word
line is connected to the gate of the transistor, and that the source of the
transistor is connected to the bit line.

Applying a voltage to the gate of the transistor which is that the word line is
connected to, that will connect/open it and allow current to flow.

If the cell's capacitor is charged, which represents a binary 1, this will
discharge just a little into the bit line which will increase that voltage
level by +δV.

If the capcitor is not charged it will charge the capacitor and the voltage
level at the source will decrease just a little by -δV:


```
              B0     B1     B2     B3     B4     B5     B6     B7
               |      |      |      |      |      |      |      |
W0             |      |      |      |      |      |      |      |
---------------|--*---|--*---|--*---|--*---|--*---|--*---|--*---|--*--
               |  |   |  |   |  |   |  |   |  |   |  |   |  |   |  |
W1             *--C   *--C   *--C   *--C   *--C   *--C   *--C   *--C
---------------|------|------|------|------|------|------|------|--*--
               |  | 1 |  | 0 |  | 1 |  | 0 |  | 0 |  | 1 |  | 1 |  | 0
W2             *--C   *--C   *--C   *--C   *--C   *--C   *--C   *--C
---------------|------|------|------|------|------|------|------|--*--       <--- Selected Row
               |  |   |  |   |  |   |  |   |  |   |  |   |  |   |  |
W3             *--C   *--C   *--C   *--C   *--C   *--C   *--C   *--C
---------------|------|------|------|------|------|------|------|--*--
               |  |   |  |   |  |   |  |   |  |   |  |   |  |   |  |
W4             *--C   *--C   *--C   *--C   *--C   *--C   *--C   *--C
---------------|------|------|------|------|------|------|------|--*--
               |  |   |  |   |  |   |  |   |  |   |  |   |  |   |  |
W5             *--C   *--C   *--C   *--C   *--C   *--C   *--C   *--C
---------------|------|------|------|------|------|------|------|--*--
               |  |   |  |   |  |   |  |   |  |   |  |   |  |   |  |
W6             *--C   *--C   *--C   *--C   *--C   *--C   *--C   *--C
---------------|------|------|------|------|------|------|------|--*--
               |  |   |  |   |  |   |  |   |  |   |  |   |  |   |  |
W7             *--C   *--C   *--C   *--C   *--C   *--C   *--C   |--C
---------------|------|------|------|------|------|------|------|-----
               |      |      |      |      |      |      |      |
          1.5V | 1.5V | 1.5V | 1.5V | 1.5V | 1.5V | 1.5V | 1.5V |
          +δV  | -δV  | +δV  | -δV  | -δV  | +δV  | +δV  | -δV  |
Sence       +----+ +----+ +----+ +----+ +----+ +----+ +----+ +----+
Amplifier   | S0 | | S1 | | S2 | | S3 | | S4 | | S5 | | S6 | | S7 |
            | 1  | | 0  | | 1  | | 0  | | 0  | | 1  | | 1  | | 0  |
            +----+ +----+ +----+ +----+ +----+ +----+ +----+ +----+
         1.5V | 1.5V | 1.5V | 1.5V | 1.5V | 1.5V | 1.5V | 1.5V |
```
Now, the sence amplifiers can detect these voltage difference. Notice that the
bit lines below the sense amplifiers are still charged with 1.5V. These
sense amplifiers are sometimes called differential sense amplifiers because
the compare the differenece between the voltage levels.
The sense amplifiers contain flip-blop latches circuits that able them to store
the value read which are represented with values inside the sense amplifier
boxes above.

Notice that reading a value is a destructive operation, by reading we have
changed the cells in the row being read. To correct this a voltage is applied
to the bit lines by the sense amplifier. If the value read was a 1 then we
know that that cell's capacitor discharged so 3V is applied tot that cells bit
line to enable the capcitor to charge. And for binary values of 0 we need to
make the capacitor discharge to 0V is applied to that bit line:
```
              B0     B1     B2     B3     B4     B5     B6     B7
               |      |      |      |      |      |      |      |
W0             |      |      |      |      |      |      |      |
---------------|--*---|--*---|--*---|--*---|--*---|--*---|--*---|--*--
               |  |   |  |   |  |   |  |   |  |   |  |   |  |   |  |
W1             *--C   *--C   *--C   *--C   *--C   *--C   *--C   *--C
---------------|------|------|------|------|------|------|------|--*--
               |  | 1 |  | 0 |  | 1 |  | 0 |  | 0 |  | 1 |  | 1 |  | 0
W2             *--C   *--C   *--C   *--C   *--C   *--C   *--C   *--C
---------------|------|------|------|------|------|------|------|--*--       <--- Selected Row
               |  |   |  |   |  |   |  |   |  |   |  |   |  |   |  |
W3             *--C   *--C   *--C   *--C   *--C   *--C   *--C   *--C
---------------|------|------|------|------|------|------|------|--*--
               |  |   |  |   |  |   |  |   |  |   |  |   |  |   |  |
W4             *--C   *--C   *--C   *--C   *--C   *--C   *--C   *--C
---------------|------|------|------|------|------|------|------|--*--
               |  |   |  |   |  |   |  |   |  |   |  |   |  |   |  |
W5             *--C   *--C   *--C   *--C   *--C   *--C   *--C   *--C
---------------|------|------|------|------|------|------|------|--*--
               |  |   |  |   |  |   |  |   |  |   |  |   |  |   |  |
W6             *--C   *--C   *--C   *--C   *--C   *--C   *--C   *--C
---------------|------|------|------|------|------|------|------|--*--
               |  |   |  |   |  |   |  |   |  |   |  |   |  |   |  |
W7             *--C   *--C   *--C   *--C   *--C   *--C   *--C   |--C
---------------|------|------|------|------|------|------|------|-----
               |      |      |      |      |      |      |      |
            3V |   0V |   3V |   0V |   0V |   3V |   3V |   0V |
Sence       +----+ +----+ +----+ +----+ +----+ +----+ +----+ +----+
Amplifier   | S0 | | S1 | | S2 | | S3 | | S4 | | S5 | | S6 | | S7 |
            | 1  | | 0  | | 1  | | 0  | | 0  | | 1  | | 1  | | 0  |
            +----+ +----+ +----+ +----+ +----+ +----+ +----+ +----+
         1.5V | 1.5V | 1.5V | 1.5V | 1.5V | 1.5V | 1.5V | 1.5V |
```
After that the word line can be disengaged.

A memory call will leak charged onto the bit line even if if the gate of the
transistor is closed. Because of this all of the cells need to be refreshed
at a regular interval which is usually every 64ms. Refreshed means that they
all have to be read and rewritten to.

```
3 Row address lines = 8 row (000-111)
RAS = Row Address Strobe, active high
CAS = Column Address Strobe, active high
WE  = Write Enable, active high

	       +-----+---+		      B0     B1     B2     B3     B4     B5     B6     B7
	       |+----| A |		       |      |      |      |      |      |      |      |
   +---+       ||+---| d |	W0             |      |      |      |      |      |      |      |
   |___|       |||   | d |---------------------|--*---|--*---|--*---|--*---|--*---|--*---|--*---|--*--
---|RAS|       |||   | r |		       |  |   |  |   |  |   |  |   |  |   |  |   |  |   |  |
   |   |       |||   | e |	W1             *--C   *--C   *--C   *--C   *--C   *--C   *--C   *--C
   |   |       |||   | s |---------------------|------|------|------|------|------|------|------|--*--
   |   |-------+||   | s |		       |  | 1 |  | 0 |  | 1 |  | 0 |  | 0 |  | 1 |  | 1 |  | 0
---|   |--------+|   |   |	W2             *--C   *--C   *--C   *--C   *--C   *--C   *--C   *--C
---|   |---------+   | R |---------------------|------|------|------|------|------|------|------|--*--       <--- Selected Row
---|   |---------+   | o |		       |  |   |  |   |  |   |  |   |  |   |  |   |  |   |  |
   |   |--------+|   | w |	W3             *--C   *--C   *--C   *--C   *--C   *--C   *--C   *--C
   |   |-------+||   |   |---------------------|------|------|------|------|------|------|------|--*--
   |   |       |||   | B |		       |  |   |  |   |  |   |  |   |  |   |  |   |  |   |  |
   |   |       |||   | u |	W4             *--C   *--C   *--C   *--C   *--C   *--C   *--C   *--C
   |   |       |||   | f |---------------------|------|------|------|------|------|------|------|--*--
   |   |       |||   | f |		       |  |   |  |   |  |   |  |   |  |   |  |   |  |   |  |
   |   |       |||   | e |	W5             *--C   *--C   *--C   *--C   *--C   *--C   *--C   *--C
   |___|       |||   | r |---------------------|------|------|------|------|------|------|------|--*--
---|CAS|       |||   |   |		       |  |   |  |   |  |   |  |   |  |   |  |   |  |   |  |
   |__ |       |||   |   |	W6             *--C   *--C   *--C   *--C   *--C   *--C   *--C   *--C
---|WE |       |||   |   |---------------------|------|------|------|------|------|------|------|--*--
   +---+       |||   |   |		       |  |   |  |   |  |   |  |   |  |   |  |   |  |   |  |
	       |||   |   |	W7             *--C   *--C   *--C   *--C   *--C   *--C   *--C   |--C
	       |||   |   |---------------------|------|------|------|------|------|------|------|-----
	       |||   +---+		       |      |      |      |      |      |      |      |
	       |||			    3V |   0V |   3V |   0V |   0V |   3V |   3V |   0V |
	       |||		Sence       +----+ +----+ +----+ +----+ +----+ +----+ +----+ +----+
               |||		Amplifier   | S0 | | S1 | | S2 | | S3 | | S4 | | S5 | | S6 | | S7 |
	       |||			    | 1  | | 0  | | 1  | | 0  | | 0  | | 1  | | 1  | | 0  |
	       |||			    +----+ +----+ +----+ +----+ +----+ +----+ +----+ +----+
	       |||			 1.5V | 1.5V | 1.5V | 1.5V | 1.5V | 1.5V | 1.5V | 1.5V |
	       |||                            |      |      |      |      |      |      |      |
               |||                          +---------------------------------------------------+
               |||                          |  Column Multiplexer/Demultiplexer                 |
               |||                          +---------------------------------------------------+
               ||+-----------------------------+            |              |     |
               |+-------------------------------------------+              |     |
               +-----------------------------------------------------------+     |
                                                                                 +--------- Data in/out
3 Column lines = 8 columns (000-111)
8 x 8 = 64 cells
```
Notice that we have 6 address lines (bus), 3 for the row address, and 3 for the
columns allowing use to address 64 individual cells. The columns selection will
select one of the bits stored in the sense amplifiers latched values. This will
then be made available to the data output pin.



### Virtual Addresses
We don't interact with physical memory directly but instead use virtual
addresses. For example, requesting a section of memory using mmap will not
provide a pointer to physical memory but will give a virtual memory address.
A virtual address consists of two parts, the page and the offset into that page.

A page is a 4098 bytes location of memory (but this can be configured to be a
different size). And the whole addressable memory is divided into sections
of the page size. So every address will reside in a page.
```
         Virtual Address                                   Physical Page Frames
   +----------------------------------------------+        +----------+
   |  Page pointer                |   Offset      |        |          |
   +----------------------------------------------+        |          |
              |                         |                  |          |
 +------------+                         +-------+          |----------|
 | +---------------------------------+          |          |          |
 | | Page0    | Physical Page Number |          |          |          |
 | |---------------------------------|          |          |          |
 +→| Page1    | Physical Page Number |-------+  |          |          |
   |---------------------------------|       +------------→|----------|
   | Page2    | Physical Page Number |          |          |          |
   | ...      |   ...                |          +---------→|          |
   | Page512  | Physical Page Number |                     |          |
   +---------------------------------+                     |----------|
         Page table                                        |          |

```

In Linux this address might look like the following:
```
           0x7F9831328000

          7F 98 31 32 80 00
  7   F     9    8   3    1    3    2    8    0    0    0
0111 1111 1001 1000 0011 0001 0011 0010 1000 0000 0000 0000

12*4 = 48 bits
```
So we can see that there ar 48 bit addresses. Now, this address is a virtual
address and on Linux it contains offsets into the page tables allowing a
mapping to the underlying physical memory.
A page table is an area of memory which is usually 4096 bytes large and
contains 512 entries called Page Table Entries which are each 64 bytes.
64 * 512 = 32768 bits, 32768/8 = 4096.
```

Now, if we create a program that contains a memory mapped file we will have
something looking like this in memory:
```
 Virtual Mem     Physical Mem
   +-----+          +------+
   |     |          |      |
   |     |          |      |
   |     |          |      |
   |     |          |      |
   |     |          |      |
   |     |          |      |
   |     |          |      |
   |     |          |      |
   |     |          |      |
   |     |     +---→|------|
   |     |     |    |      | Memory mapped file (mmap.txt)
   |-----|-----+    |      |
   |-----|          |------|
   |     |          |      |
   |     |          |      |
   |     |          |      |
   +-----+          +------+
```
So we have a virtual memory returned from `mmap` which points to this memory
mapped file. Now, if we create another we get something that looks like this:
```
 Virtual Mem     Physical Mem
   +-----+          +------+
   |     |          |      |
   |     |          |      |
   |     |          |      |
   |     |     +---→|------|
   |     |     |    |------|-+
   |     |     |    |      | |
   |     |     |    |      | |
   |-----|-----+    |      | |
   |-----|          |      | |
   |     |     +---→|------|←+
   |     |     |    |      | Memory mapped file (mmap.txt)
   |-----|-----+    |      |
   |-----|          |------|
   |     |          |      |
   |     |          |      |
   |     |          |      |
   +-----+          +------+

```
There is an example in [mmap.c](../src/mmap.c) which shows this:
```console
$ make mmap
$ ./mmap
Reading file mmap.txt
Read length 6
pagesize: 4096
v_addr1: 0x7f4529a93000
v_addr1 value: bajja

v_addr2: 0x7f4529a92000
v_addr2 value: bajja
```
So we have two virtual addresses that point to the same memory mapped file.
Now, every process has its own page table(s). And as we mentioned above
each page table is 4K (4096 bytes) and contains 512 entries. In the example
here we only created two mappings to the same file, but what if we did this
millions of times. This would create many page table and page table entries
in physical memory which are all pointing to the same memory mapped file:
```
 Virtual Mem     Physical Mem
   +-----+          +------+
   |     |          |------|-+
   |     |          |------|-|
   |     |          |------|-|
   |     |     +---→|------|-|
   |     |     |    |------|-|
   |     |     |    |------|-|
   |     |     |    |------|-|
   |-----|-----+    |------|-|
   |-----|          |------|-|
   |     |     +---→|------|←+
   |     |     |    |      | Memory mapped file (mmap.txt)
   |-----|-----+    |      |←+
   |-----|          |------|-|
   |     |          |------|-|
   |     |          |------|-|
   |     |          |------|-|
   +-----+          +------+
```
Now, if we can cause a bit flip in the page table entries that are pointing to
our shared memory mapped file and be lucky to flip a bit in the address portion
of the pointer we can make that entry point to a different location in
physical memory. The chances are pretty good that this new address will hit
one of the page table entries in memory, as mmap created so many. And since
we have virtual address pointers to these locations, which remember as pointing
to the memory mapped file originaly, but if that pointer is changed by a bit
flip it will no longer point to that memory mapped file, but instead it will
point to a page table entry. Just like we could use the original pointer to
modify the memory mapped file, we can still do that after the bit flip, but now
the modification will not affect the memory mapped file but instead it will
modify the page table entry which is not owned by the kernel process. We can
therefor write to any location in the physical address space and not only the
address space that was given to the process via the virtual address space. 

This allows for overwriting the entry point of an run shell code.

