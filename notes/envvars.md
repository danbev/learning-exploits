### Environment variables
An environment variable can be used to exploit a program as it is something that
is controlled by an attacher. It might be possible to use in a buffer overflow
depending on how the data is used. 


### Node NODE_EXTRA_CA_CERTS environment variable
This environment variable can be set NODE_EXTRA_CA_CERTS and if so Node will
upon startup use the value to try to read a file from the file system. If this
is successful this file will be read and certificates found in it will be
added added to OpenSSL's trusted certificates store:
```c++
  X509_STORE_add_cert(store, x509);
```
In node if the AT_SECURE has been set on the binary it will not be possible to
set this value as there is the following check in src/node_credentials.cc:
```c++
// Look up environment variable unless running as setuid root.                  
bool SafeGetenv(const char* key, std::string* text, Environment* env) {         
#if !defined(__CloudABI__) && !defined(_WIN32)                                  
  if (per_process::linux_at_secure || getuid() != geteuid() ||                  
      getgid() != getegid())                                                    
    goto fail;                                                                  
#endif 
```
Lets run this and see what happens if we set `NODE_EXTRA_CA_CERTS`:
```console
$ env NODE_EXTRA_CA_CERTS=bajja ./out/Debug/node -p 'process.versions.v8'
uid: 1000, euid: 1000, gid: 1000, egid 1000
uid: 1000, euid: 1000, gid: 1000, egid 1000
uid: 1000, euid: 1000, gid: 1000, egid 1000
uid: 1000, euid: 1000, gid: 1000, egid 1000
uid: 1000, euid: 1000, gid: 1000, egid 1000
uid: 1000, euid: 1000, gid: 1000, egid 1000
uid: 1000, euid: 1000, gid: 1000, egid 1000
uid: 1000, euid: 1000, gid: 1000, egid 1000
Warning: Ignoring extra certs from `bajja`, load failed: error:02001002:system library:fopen:No such file or directory
uid: 1000, euid: 1000, gid: 1000, egid 1000
uid: 1000, euid: 1000, gid: 1000, egid 1000
uid: 1000, euid: 1000, gid: 1000, egid 1000
8.9.255.19-node.16
```
Lets try setting a capability on the executable using `setcap`:
```console
$ sudo setcap cap_net_bind_service+ep /home/danielbevenius/work/nodejs/node-debug/out/Debug/node
$ ls -l out/Debug/node
-rwxrwxr-x. 1 danielbevenius danielbevenius 1432217856 Mar 12 09:28 out/Debug/node
$ getcap out/Debug/node
out/Debug/node = cap_net_bind_service+ep
```
If we run our program again we see:
```console
$ env NODE_EXTRA_CA_CERTS=bajja ./out/Debug/node -p 'process.versions.v8'
uid: 1000, euid: 1000, gid: 1000, egid 1000
uid: 1000, euid: 1000, gid: 1000, egid 1000
uid: 1000, euid: 1000, gid: 1000, egid 1000
uid: 1000, euid: 1000, gid: 1000, egid 1000
uid: 1000, euid: 1000, gid: 1000, egid 1000
uid: 1000, euid: 1000, gid: 1000, egid 1000
uid: 1000, euid: 1000, gid: 1000, egid 1000
uid: 1000, euid: 1000, gid: 1000, egid 1000
uid: 1000, euid: 1000, gid: 1000, egid 1000
uid: 1000, euid: 1000, gid: 1000, egid 1000
uid: 1000, euid: 1000, gid: 1000, egid 1000
8.9.255.19-node.16
```
Notice that this time there was no warning printed as the environment variable
is not allowed to be read. And also notice that our real user/group ids are the
same as the effective user/group ids.

Lets remove the capability:
```console
$ sudo setcap -r /home/danielbevenius/work/nodejs/node-debug/out/Debug/node
$ ls -l out/Debug/node
-rwxrwxr-x. 1 danielbevenius danielbevenius 1432217840 Mar 12 07:15 out/Debug/node
```
And lets change the owner and group to root and set the `setuid` bit:
```console
$ sudo chown root:root out/Debug/node
$ ls -l out/Debug/node
-rwxrwxr-x. 1 root root 1432217840 Mar 12 07:15 out/Debug/node

$ sudo chmod u+s out/Debug/node
$ ls -l out/Debug/node
-rwsrwxr-x. 1 root root 1432217840 Mar 12 07:15 out/Debug/node
```
Now we run this we can inspect the user and group ids:
```console
$ env NODE_EXTRA_CA_CERTS=bajja ./out/Debug/node -p 'process.versions.v8'
uid: 1000, euid: 0, gid: 1000, egid 1000
uid: 1000, euid: 0, gid: 1000, egid 1000
uid: 1000, euid: 0, gid: 1000, egid 1000
uid: 1000, euid: 0, gid: 1000, egid 1000
uid: 1000, euid: 0, gid: 1000, egid 1000
uid: 1000, euid: 0, gid: 1000, egid 1000
uid: 1000, euid: 0, gid: 1000, egid 1000
uid: 1000, euid: 0, gid: 1000, egid 1000
uid: 1000, euid: 0, gid: 1000, egid 1000
uid: 1000, euid: 0, gid: 1000, egid 1000
uid: 1000, euid: 0, gid: 1000, egid 1000
8.9.255.19-node.16
```
Now, in this case we can see that the effective user id is different as the
setuid was used. 

My understanding of capabilities is that they allow a process to have more fine
grained privileges but can avoid then having to use setuid.

Currently it does not look like this is possible with Node. 

As a suggestion I'd like to add a function named something like GetCapSafeEnv
that will look at AT_SECURE and see if it is set, which would be the case for
`setuid` and if a capailitiy has been set. But if the AT_SECURE is set and the
real/effective user/group ids are the same allow this the variable to be read. 
So we would check that AT_SECURE (setuid and caps) but allow if the
real/effective user/group ids are the same. But we might have the case where
the user and group are the same and this is the root user I guess. Perhaps we
should have an extra check that this is not the root user even though it is not
recommended to run node as the root user.

Having a new function means that this would not affect JavaScript code at they
still use the other GetSafeEnv function.

After adding the function SafeCapGetenv I went through the following senarios:
1) No capabilities or setuid and normal user:
```console
$ env NODE_EXTRA_CA_CERTS=bajja ./out/Release/node -p 'process.versions.node'
uid: 1000, euid: 1000, gid: 1000, egid 1000
Warning: Ignoring extra certs from `bajja`, load failed: error:02001002:system library:fopen:No such file or directory
16.0.0-pre
```
All good we where able to read the environment variable, hence the warning.

2) Capabilities set and normal user:
```console
sudo setcap cap_net_bind_service+ep /home/danielbevenius/work/nodejs/node-debug/out/Release/node
$ env NODE_EXTRA_CA_CERTS=bajja ./out/Release/node -p 'process.versions.node'
uid: 1000, euid: 1000, gid: 1000, egid 1000
Warning: Ignoring extra certs from `bajja`, load failed: error:02001002:system library:fopen:No such file or directory
16.0.0-pre
```
Notice that we again where able to read the environment variable. This is change
as setting capability would prevent the environment varaible from being read.

3) setuid and normal user
```console
$  sudo setcap -r /home/danielbevenius/work/nodejs/node-debug/out/Release/node
$ ls -l out/Release/node
-rwxrwxr-x. 1 danielbevenius danielbevenius 78216656 Mar 12 11:59 out/Release/node
$ sudo chown root:root out/Release/node
$ sudo chmod u+s out/Release/node
$ ls -l out/Release/node
-rwsrwxr-x. 1 root root 78216656 Mar 12 11:59 out/Release/node
$ env NODE_EXTRA_CA_CERTS=bajja ./out/Release/node -p 'process.versions.node'
uid: 1000, euid: 0, gid: 1000, egid 1000
16.0.0-pre
```
Notice that the warning is not there and the environment variable was not read.

4) Capabilities and root user:
```console
$ sudo chmod u-s out/Release/node
$ ls -l out/Release/node
-rwxrwxr-x. 1 root root 78216656 Mar 12 11:59 out/Release/node
$ getcap out/Release/node
out/Release/node = cap_net_bind_service+ep
$ su -
$ cd /path/to/node/sources
$ env NODE_EXTRA_CA_CERTS=bajja ./out/Release/node -p 'process.versions.node'
uid: 0, euid: 0, gid: 0, egid 0
getuid() == 0: true
16.0.0-pre
```
No warning as the environment variable is not read.

The motivation for this change is a use case where node is run in a container
and the is a requirement to be able to listen to ports below 1024. This is done
by setting the capability of cap_net_bin_service. In addition there is a need
to set the environment variable `NODE_EXTRA_CA_CERTS`. But currently this
environment variable will not be read.

This commit suggests adding a function named SafeCapGetenv which takes into
consideration if a capability has been set and if so allow the reading of the
environment variable. This is a separate function so that it does not affect
and JavaScript methods that currently use SafeGetenv.

```c++
printf("uid: %d, euid: %d, gid: %d, egid %d\n", getuid(), geteuid(), getgid(), getegid());
printf("getuid() == 0: %s\n", getuid() == 0 ? "true":"false");
```
